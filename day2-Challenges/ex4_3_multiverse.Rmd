---
title: "Multiverse Analysis of Hurricane Names"
output: html_document
---

This exercise is based on this: https://rdrr.io/cran/multiverse/f/vignettes/example-hurricane.Rmd

Other fully worked example: https://cran.r-project.org/web/packages/multiverse/vignettes/visualising-multiverse.html

![](images/clipboard-3789722207.png)

![](images/clipboard-4193840793.png)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(multiverse)
library(ggplot2)
```


```{r data, include=FALSE}
data("hurricane", package = "multiverse")

hurricane_data <- hurricane %>%
  rename(
    year = Year,
    name = Name,
    dam = NDAM,
    death = alldeaths,
    female = Gender_MF,
    masfem = MasFem,
    category = Category,
    pressure = Minpressure_Updated_2014,
    wind = HighestWindSpeed
  ) %>%
  mutate(
    post = ifelse(year > 1979, 1, 0),
    zcat = as.numeric(scale(category)),
    zpressure = -scale(pressure),
    zwind = as.numeric(scale(wind)),
    z3 = as.numeric((zpressure + zcat + zwind) / 3),
    severity = (zpressure + zcat + zwind) / 3
    )

```


```{multiverse label = default-m-4, inside = M}
M <- multiverse()

inside(M, {
  # Define alternative hurricane filtering choices
  remove_extreme <- branch(remove_extreme, TRUE, FALSE)
  
  # Apply filtering based on the condition
  df <- hurricane_data %>%
    filter(!(remove_extreme & name %in% c("Katrina", "Audrey")))

  # Define alternative regression model families
  model_type <- branch(model_type, "poisson", "gaussian")

  fit <- glm(death ~ masfem * severity, data = df, family = model_type)
})

```

```{r check-multiverse, include=FALSE}

execute_multiverse(M)
summary(M)
#plot(M)

library(ggplot2)
library(tidyr)
library(dplyr)
library(purrr)
library(broom)

# Expand multiverse results
p <- expand(M) |> 
  mutate(summary_fit = map(.results, broom::tidy)) |> 
  #unnest(cols = c(summary_fit)) |> 
  mutate(term = recode(term, 
                 "masfem" = "Masculine-Feminine Name Score",
                 "masfem:severity" = "Interaction: Name & Severity"
  )) |> 
  filter(term != "(Intercept)") |> 
  ggplot() +  
  geom_vline(xintercept = 0, colour = '#979797') +  
  geom_point(aes(x = estimate, y = term)) +  
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high, y = term), height = 0) +  
  theme_minimal() +  
  transition_manual(.universe)  # Animates across different universes

p

animate(p, nframes = 210, fps = 2)

```

summary(M)

Questions ...

Hint ...


